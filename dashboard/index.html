<!doctype html>

<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>Available 3D Printers</title>
    <link rel="icon" href="/favicon.ico">
    <link rel="icon" href="/favicon.png" type="image/png">
    <link rel="apple-touch-icon" href="/favicon.png">

    <style>
        body {
            font-family: Arial, Helvetica, sans-serif;
        }
        h1 {
            font-size: 1.5em;
        }

        printer { display: inline-block; }
        printer .camera {
            cursor: pointer;
            margin-left: 0.6em;
            height: 1em;
            vertical-align: top;
        }
        printer .name {
            cursor: pointer;
            margin-left: 0.6em;
            font-weight: bold;
            text-decoration: none;
            color: inherit;
        }
        .status {
            display: inline-block;
            width: 1em; height: 1em;
            vertical-align: middle;
            background-size: 100%;
            background-image: url('yellow.png');
        }
        .status.ready { background-image: url('green.png'); }
        .status.printing { background-image: url('blue.png'); }
        .status.paused { background-image: url('purple.png'); }
        .status.done { background-image: url('cyan.png'); }
        .status.error { background-image: url('red.png'); }

        #container {
            display: none;
            position: fixed; top: 0; left: 0; bottom: 0; right: 0;
            background: #333333AA;
            z-index: 10;
            text-align: center;
            overflow: hidden;
        }
        #display {
            position: absolute; top: 50%; left: 50%; -ms-transform: translate(-50%, -50%); transform: translate(-50%, -50%);
            background: black;
            z-index: 11;
            text-align: center;
            border: 5px solid #555555; border-radius: 5px;
            width: 100%; max-width: 650px; max-height: 490px; aspect-ratio: 4 / 3;
            padding: 5px;
        }
        #display iframe, #display img { width: 100%; height: 100%; border: 0; color: red; }
        table { border-collapse: collapse; }
        table td { border-bottom: 1px solid black; padding: 0.2em 1em; }
        table td:first-child { padding-left: 0; }
    </style>

    <script>
        function show_camera(elem_type, url) {
            let display = document.getElementById('display');
            let elem = document.createElement(elem_type);
            elem.src = url;
            elem.id = 'camera';
            display.appendChild(elem);
            document.getElementById('container').style.display = 'block';
        }

        function close_camera() {
            document.getElementById('container').style.display = 'none';
            let camera = document.getElementById('camera');
            if (camera) { camera.remove(); }
        }

        function fetch_printer_status_ender(printer) {
            const status = printer.getElementsByClassName('status')[0];
            const apikey = printer.getAttribute('apikey', '3D3D3D3D3D3D3D')
            fetch(printer.api_url+'/printer', {'headers': {'X-Api-Key': apikey}})
            .then(response => response.json())
            .then(data => {
                const state = data.state;
                if (state.paused || state.pausing) {
                    status.className = 'status paused';
                } else if (state.printing || state.resuming || state.finishing || state.cancelling) {
                    status.className = 'status printing';
                } else if (state.closedOrError || state.error) {
                    status.className = 'status error';
                } else if (state.operational || state.ready) {
                    status.className = 'status ready';
                } else {
                    status.className = 'status';
                }
            })
            .catch(() => { status.className = 'status'; });
        }

        function fetch_printer_status_ultimaker(printer) {
            const status = printer.getElementsByClassName('status')[0];
            fetch(printer.api_url+'/printer')
            .then(response => response.json())
            .then(data => {
                const state = data.status;
                if (state === 'printing') {
                    // need to request the print-job information
                    fetch(printer.api_url+'/print_job')
                    .then(response => response.json())
                    .then(data => {
                        const state = data.state;
                        if (state === 'printing' || state === 'resuming' || state === 'pre_print' || state === 'post_print') {
                            status.className = 'status printing';
                        } else if (state === 'paused' || state === 'pausing') {
                            status.className = 'status paused';
                        } else if (state === 'wait_cleanup' || state === 'wait_user_action' || state === 'none') {
                            status.className = 'status done';
                        } else { // if (state === 'unknown') {
                            status.className = 'status';
                        }
                    })
                    .catch(() => { state.className = 'status'; });
                } else if (state === 'error' || state === 'maintenance' || state === 'booting') {
                    status.className = 'status error';
                } else if (state === 'idle') {
                    status.className = 'status ready';
                } else {
                    status.className = 'status';
                }
            })
            .catch(() => { status.className = 'status'; });
        }

        function fetch_printer_status(printer) {
            const type = printer.getAttribute('type');
            if (type === 'ender') { return fetch_printer_status_ender(printer); }
            else if (type === 'ultimaker') { return fetch_printer_status_ultimaker(printer); }
        }

        function create_printer(printer) {
            const name = printer.id;
            const type = printer.getAttribute('type');
            const domain = 'http://' + name.toLowerCase() + '.cslab.moravian.edu';
            printer.domain = domain;
            if (type === 'ultimaker') {
                printer.api_url = domain + '/api/v1';
                printer.link_url = domain + '/print_jobs';
                printer.camera_url = domain + ':8080/?action=stream';
                printer.camera_type = 'img'
            } else if (type === 'ender') {
                printer.api_url = domain + '/api';
                printer.link_url = domain + '/';
                const port = printer.hasAttribute('camera-port') ? printer.getAttribute('camera-port') : 12345;
                printer.camera_url = domain + ':' + port + '/?action=stream';
                printer.camera_type = 'img';
            } else if (type === 'epsilon') {
                printer.api_url = null;
                printer.link_url = 'https://cloud.bcn3d.com/';
                printer.camera_url = null;  // TODO
                printer.camera_type = 'iframe';
            }

            const status = printer.appendChild(document.createElement('span'));
            status.className = 'status';
            fetch_printer_status(printer);

            if (printer.camera_url !== null) {
                const camera = printer.appendChild(document.createElement('img'));
                camera.className = 'camera';
                camera.src = 'camera.png';
                camera.alt = 'view camera';
                camera.addEventListener('click', () => {
                    show_camera(printer.camera_type, printer.camera_url);
                });
            }

            const link = printer.appendChild(document.createElement('a'));
            link.className = 'name';
            link.textContent = name;
            link.href = printer.link_url;
        }

        function on_load() {
            document.getElementById('container').addEventListener('click', close_camera);
            document.addEventListener('keyup', (e) => { if (e.keyCode === 27) { close_camera(); } });
            for (let printer of document.getElementsByTagName('printer')) {
                create_printer(printer);
            }
        }
    </script>
</head>

<!--
    TODO:
    - Ender 3 camera ports (and maybe URL)
    - Test everything
-->

<body onload="on_load();">
    <div id="container"><div id="display"></div></div>
    <p>Reminder: most of these will only work while on-campus or with special setups involving the SSH jumpbox.</p>
    <p><b>Statuses:</b>
        <span class="status ready"></span> Available / Ready |
        <span class="status printing"></span> Printing |
        <span class="status paused"></span> Paused |<br>
        <span class="status error"></span> Unavailable / Being Repaired | 
        <span class="status"></span> Unknown
    </p>

    <h1>Ender 3s on the Rack</h1>
    <table>
        <tr>
            <td><printer type="ender" id="Bacchus" apikey="3DE4DE53DE4DE5"></td>
            <td><printer type="ender" id="Hera" apikey="3DE4DE53DE4DE5"></td>
        </tr>
        <tr>
            <td><printer type="ender" id="Talos" apikey="3DE4DE53DE4DE5"></td>
            <td><printer type="ender" id="Athena" apikey="3DE4DE53DE4DE5"></td>
        </tr>
        <tr>
            <td><printer type="ender" id="Vulcan" apikey="3DE4DE53DE4DE5"></td>
            <td><printer type="ender" id="Kratos" apikey="3DE4DE53DE4DE5"></td>
        </tr>
    </table>

    <h1>Ender 3s on the Table</h1>
    <!--<p><printer type="ender" id="???" apikey="3DE4DE53DE4DE5"></p>
    <p><printer type="ender" id="???" apikey="3DE4DE53DE4DE5"></printer> (printer with direct drive)</p>-->

    <h1>Ultimakers</h1>
    <p><printer type="ultimaker" id="Gutenberg"></p>
    <p><printer type="ultimaker" id="Xerox"></p>

    <h1>Epsilon W50s</h1>
    <p><printer type="epsilon" id="Ada"></p>
</body>
</html>
